<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>WebSocket ì±„íŒ… í…ŒìŠ¤íŠ¸</title>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
</head>
<body>
  <h2>ì±„íŒ… í…ŒìŠ¤íŠ¸</h2>

  <label>
    ìœ ì € ID:
    <input type="text" id="userId" value="user123" />
  </label><br />
  <label>
    ë‹‰ë„¤ì„:
    <input type="text" id="nickname" value="í™ê¸¸ë™" />
  </label><br />
  <label>
    ë°© ì½”ë“œ:
    <input type="text" id="roomCode" value="room1234" />
  </label><br /><br />

  <button onclick="connectSocket()">ì†Œì¼“ ì—°ê²°</button>
  <button onclick="joinRoom()">ë°© ì…ì¥</button>
  <button onclick="getChatLogs()">ì±„íŒ… ë¡œê·¸ ë¶ˆëŸ¬ì˜¤ê¸°</button><br /><br />

  <input type="text" id="messageInput" placeholder="ë©”ì‹œì§€ ì…ë ¥ (ì˜ˆ: <script>alert(1)</script>)" style="width: 300px;" />
  <button onclick="sendMessage()">ë©”ì‹œì§€ ë³´ë‚´ê¸°</button>

  <h3>ì±„íŒ… ë¡œê·¸</h3>
  <div id="chatLog" style="border:1px solid #ccc; padding:10px; width:400px; height:300px; overflow-y:scroll;"></div>

  <script>
    let socket;

    function connectSocket() {
      const userId = document.getElementById('userId').value;
      const nickname = document.getElementById('nickname').value;

      socket = io('http://localhost:3000', {
        auth: { userId, nickname },
      });

      socket.on('connect', () => {
        logMessage(`âœ… ì—°ê²°ë¨ (socket.id: ${socket.id})`);
      });

      socket.on('joined_room', (data) => {
        logMessage(`ğŸŸ¢ ë°© ì…ì¥: ${data.roomCode}`);
      });

      socket.on('user_joined', (data) => {
        logMessage(`ğŸ‘¤ ${data.nickname} ë‹˜ì´ ì…ì¥í•˜ì…¨ìŠµë‹ˆë‹¤.`);
      });

      socket.on('receive_message', (data) => {
        logMessage(`ğŸ’¬ ${data.nickname}: ${data.message}`);
      });

      socket.on('chat_logs', (logs) => {
        if (logs.length === 0) {
          logMessage('ğŸ“­ ì±„íŒ… ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.');
        } else {
          logMessage('ğŸ“œ ì±„íŒ… ë¡œê·¸:');
          logs.forEach(msg => {
            logMessage(`ğŸ•“ ${msg.nickname}: ${msg.message}`);
          });
        }
      });

      socket.on('error', (err) => {
        logMessage(`âŒ ì—ëŸ¬: ${err.reason || JSON.stringify(err)}`);
      });

      socket.on('disconnect', () => {
        logMessage('ğŸ”Œ ì—°ê²° ì¢…ë£Œë¨');
      });
    }

    function joinRoom() {
      if (!socket?.connected) return alert('ì†Œì¼“ì´ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
      const roomCode = document.getElementById('roomCode').value;
      socket.emit('join_room', { roomCode });
    }

    function sendMessage() {
      if (!socket?.connected) return alert('ì†Œì¼“ì´ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
      const roomCode = document.getElementById('roomCode').value;
      const message = document.getElementById('messageInput').value.trim();

      if (!message) {
        return alert('ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      }

      socket.emit('send_message', { roomCode, message });
      document.getElementById('messageInput').value = '';
    }

    function getChatLogs() {
      if (!socket?.connected) return alert('ì†Œì¼“ì´ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
      const roomCode = document.getElementById('roomCode').value;
      socket.emit('get_chat_logs', { roomCode });
    }

    function logMessage(msg) {
      const chatLog = document.getElementById('chatLog');
      const div = document.createElement('div');
      div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
      chatLog.appendChild(div);
      chatLog.scrollTop = chatLog.scrollHeight;
    }
  </script>
</body>
</html>
