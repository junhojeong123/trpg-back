<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>TRPG Chat API 테스트</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    button { margin: 5px; padding: 8px 12px; }
    pre { background: #f4f4f4; padding: 10px; border-radius: 6px; }
  </style>
</head>
<body>
  <h1>TRPG Chat API 테스트</h1>
  <button id="healthBtn">💓 Health 체크</button>
  <button id="signupBtn">📝 회원가입</button>
  <button id="loginBtn">🔑 로그인</button>
  <button id="validateBtn">✅ 토큰 검증</button>
  <button id="chatBtn">💬 채팅 로그</button>
  <button id="runAllBtn">🚀 전체 자동 실행</button>
  <pre id="output"></pre>

  <script>
    const output = document.getElementById("output");
    let accessToken = "";

    function log(message) {
      output.textContent += message + "\n";
    }

    // 공통 fetch 함수
    async function callAPI(url, options = {}, label = "") {
      try {
        const res = await fetch(url, options);
        const data = await res.json();
        log(`${label}: ${JSON.stringify(data)}`);
        return data;
      } catch (err) {
        log(`${label} 오류: ${err.message}`);
      }
    }

    // 개별 버튼 이벤트
    document.getElementById("healthBtn").addEventListener("click", () =>
      callAPI("http://localhost:3000/health", {}, "Health")
    );

    document.getElementById("signupBtn").addEventListener("click", () =>
      callAPI("http://localhost:3000/users", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name: "Alice", nickname: "alice", email: "alice@example.com", password: "1234" })
      }, "Signup")
    );

    document.getElementById("loginBtn").addEventListener("click", async () => {
      const data = await callAPI("http://localhost:3000/auth/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email: "alice@example.com", password: "1234" })
      }, "Login");
      if (data?.access_token) {
        accessToken = data.access_token;
        log("👉 Access Token 저장됨");
      }
    });

    document.getElementById("validateBtn").addEventListener("click", () =>
      callAPI("http://localhost:3000/auth/validate-token", {
        headers: { "Authorization": "Bearer " + accessToken }
      }, "Validate Token")
    );

    document.getElementById("chatBtn").addEventListener("click", () =>
      callAPI("http://localhost:3000/chat/logs?roomId=1", {}, "Chat Logs")
    );

    // 전체 실행
    document.getElementById("runAllBtn").addEventListener("click", async () => {
      output.textContent = "";
      log("=== 자동 테스트 시작 ===");

      await callAPI("http://localhost:3000/health", {}, "1. Health");
      await callAPI("http://localhost:3000/users", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name: "Alice", nickname: "alice", email: "alice@example.com", password: "1234" })
      }, "2. Signup");

      const login = await callAPI("http://localhost:3000/auth/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email: "alice@example.com", password: "1234" })
      }, "3. Login");
      if (login?.access_token) {
        accessToken = login.access_token;
        log("👉 Access Token 저장됨");
      }

      await callAPI("http://localhost:3000/auth/validate-token", {
        headers: { "Authorization": "Bearer " + accessToken }
      }, "4. Validate Token");

      await callAPI("http://localhost:3000/chat/logs?roomId=1", {}, "5. Chat Logs");

      log("=== 테스트 완료 ===");
    });
  </script>
</body>
</html>
